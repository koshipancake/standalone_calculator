<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Comisiones 3D</title>
  
  <script src="script/react.development.js"></script>
  <script src="script/react-dom.development.js"></script>
  <script src="script/babel.min.js"></script>
  <script src="script/tailwindcss.js"></script>
  <script src="script/jspdf.umd.min.js"></script>
  
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .slider::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: #3B82F6; cursor: pointer; border-radius: 50%; }
  </style>
</head>
<body class="bg-gray-50 p-4">
  <div id="root"></div>

  <script type="text/babel">
  // --- Hooks y Constantes de React --- (No catch statement found)
    const { useState, useRef, useEffect } = React;
    const root = ReactDOM.createRoot(document.getElementById('root'));

    // --- Componentes de iconos SVG ---
    const Calculator = () => (
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8">
        <rect x="4" y="3" width="16" height="18" rx="2"/>
        <path d="M8 7h8" />
        <path d="M8 11h1M11 11h1M14 11h1" />
        <path d="M8 15h1M11 15h1M14 15h1" />
      </svg>
    );

    const Download = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg>
    );

    const Settings = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8">
        <circle cx="12" cy="12" r="3" />
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 0 1 4.3 17.9l.06-.06A1.65 1.65 0 0 0 4 16a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4 9a1.65 1.65 0 0 0-.33-1.82L3.6 6.12A2 2 0 0 1 6.43 3.3l.06.06A1.65 1.65 0 0 0 8 4c.48 0 .92.18 1.26.5.34.33.5.78.5 1.25V7a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 0 1 17.7 6.1l-.06.06A1.65 1.65 0 0 0 18 8c0 .48-.18.92-.5 1.26-.33.34-.78.5-1.25.5H15a1.65 1.65 0 0 0-1.51 1V12c0 .48.18.92.5 1.26.33.34.78.5 1.25.5h1.09A1.65 1.65 0 0 0 18 15z"/>
      </svg>
    );

    const DollarSign = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8">
        <path d="M12 1v22" />
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
      </svg>
    );

    const Package = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
        <path d="M12 3v10" />
      </svg>
    );

    // --- Traducciones ---
    const translations = {
      invoiceTitle: { es: 'FACTURA DE COMISIÓN 3D', en: '3D COMMISSION INVOICE' },
      thankYou: { es: 'Gracias por confiar en mi servicio', en: 'Thank you for your business' },
      autoGeneratedNote: { es: 'Esta factura fue generada automáticamente.', en: 'This is an auto-generated invoice.' },
      modelSection: { es: 'MODELO 3D:', en: '3D MODEL:' },
      portingSection: { es: 'PORTEO:', en: 'PORTING:' },
      extrasSection: { es: 'SERVICIOS ADICIONALES', en: 'ADDITIONAL SERVICES' },
      priceBreakdown: { es: 'DESGLOSE DE PRECIOS', en: 'PRICE BREAKDOWN' },
      discountsAndFees: { es: 'DESCUENTO & COMISIONES', en: 'DISCOUNTS & FEES' },
      complexity: { es: 'Complejidad', en: 'Complexity' },
      textureComplexity: { es: 'Complejidad Textura', en: 'Texture Complexity' },
      type: { es: 'Tipo', en: 'Type' },
      estimatedPrice: { es: 'Precio estimado', en: 'Estimated Price' },
      game: { es: 'Juego', en: 'Game' },
      basePrice: { es: 'Precio base', en: 'Base price' },
      totalDue: { es: 'Total a pagar', en: 'Total due' },
      paypalFee: { es: 'Comisión PayPal', en: 'PayPal Fee' },
      subtotal: { es: 'Subtotal', en: 'Subtotal' },
      discountPercent: { es: 'Descuento', en: 'Discount' }
    };

  // --- Utilidades y funciones auxiliares --- (No catch statement found)
    function usePersistentState(key, initialValue) {
      const [value, setValue] = useState(() => {
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch (e) { 
          return initialValue; 
        }
      });

      useEffect(() => {
        window.localStorage.setItem(key, JSON.stringify(value));
      }, [key, value]);

      return [value, setValue];
    }

    const generateInvoiceNumber = () => {
      return Math.floor(Math.random() * 900000) + 100000;
    };

    const getModelTypeTranslation = (type) => {
      const types = {
        total: 'Hecho total de 0',
        edit: 'Model Edit',
        partial: 'Parcial',
        accessories: 'Solo accesorios parciales'
      };
      return types[type] || type;
    };

    const loadImage = (src) => {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    };

    const calculateModelPrice = (model) => {
      // Base price calculation with non-linear scaling (reduced by 4%)
      let price;
      switch(model.complexity) {
        case 1: price = 5.76; break;
        case 2: price = 7.68; break;
        case 3: price = 11.52; break;
        case 4: price = 15.36; break;
        case 5: price = 17.28; break;
        case 6: price = 19.20; break;
        case 7: price = 20.16; break;
        case 8: price = 21.12; break;
        case 9: price = 22.08; break;
        case 10: price = 24.00; break;
        default: price = 5.76;
      }
      
      // Apply type multipliers
      const typeMultipliers = {
        total: 1,
        edit: 0.6,
        partial: 0.4,
        accessories: 0.3
      };
      price *= typeMultipliers[model.type] || 1;
      
      // Texture complexity adds 8 USD per level (max 40 USD at level 5)
      price += model.textureComplexity * 8;

      // Additional features
      if (model.hasExpressions) price += (model.expressionCount || 1) * 0.25;
      if (model.hasPhysics) {
        let physicsPrice = 0;
        if (model.physicsBust) physicsPrice += 0.36;
        if (model.physicsHair) physicsPrice += 0.67 * (model.physicsHairComplexity || 1);
        if (model.physicsEar) physicsPrice += 0.36;
        if (model.physicsTail) physicsPrice += 0.36;
        if (model.physicsOther) physicsPrice += parseFloat(model.physicsOtherPrice) || 0;
        price += physicsPrice;
      }
      if (model.hasAccessories) price += 10;
      
      return price;
    };

    const calculatePortPrice = (portData, activeTab, modelList) => {
      const basePrice = {
        gta_sa: 3,
        gta_vc: 3,
        gta_v: 12,
        garrys_mod: 8,
        left4dead2: 12,
        vrm: 15
      }[portData.game] || 30;

      let total = basePrice;
      // Check if any model already has expressions (only in 'ambos' mode)
      const modelHasExpressions = activeTab === 'ambos' ? modelList.some(model => model.hasExpressions) : false;
      // Only charge for expressions in Garry's Mod if the model doesn't already have them
      if (portData.hasExpressions && !(portData.game === 'garrys_mod' && modelHasExpressions)) {
        total += portData.expressionCount * 5;
      }
      if (portData.hasPhysics) {
        total += 15;
      }
      if (portData.hasAccessories) {
        total += portData.accessoryComplexity * 8;
      }
      return total;
    };

  // --- Componente Principal --- (No catch statement found)
    function CommissionCalculator() {
      // Estados
      const [activeTab, setActiveTab] = usePersistentState('activeTab', 'modelo');
      const [modelList, setModelList] = usePersistentState('modelList', []);
      
      // Initialize modelList if empty and we're in a mode that uses models
      useEffect(() => {
        if ((activeTab === 'modelo' || activeTab === 'ambos')) {
          if (!Array.isArray(modelList) || modelList.length === 0) {
            setModelList([{
              name: '',
              desc: '',
              complexity: 5,
              type: 'total',
              textureComplexity: 0,
              expressionCount: 1,
              hasExpressions: false,
              hasPhysics: false,
              hasAccessories: false
            }]);
          }
        }
      }, [activeTab, modelList]);
      const [portData, setPortData] = usePersistentState('portData', {
        game: 'gta_sa',
        hasExpressions: false,
        expressionCount: 0,
        expressionNames: '',
        hasPhysics: false,
        hasAccessories: false,
        accessoryComplexity: 1
      });
      const [paypalData, setPaypalData] = usePersistentState('paypalData', {
        percentage: 5.4,
        fixed: 0.30
      });
      const [discountData, setDiscountData] = usePersistentState('discountData', {
        enabled: false,
        percentage: 0,
        reason: ''
      });
      const [extraCharges, setExtraCharges] = usePersistentState('extraCharges', []);
      const [isEnglish, setIsEnglish] = useState(false);

      const canvasRef = useRef(null);

      const getTotalPrice = () => {
        let basePrice = 0;
        if (activeTab === 'modelo' || activeTab === 'ambos') {
          modelList.forEach(model => {
            basePrice += calculateModelPrice(model);
          });
        }
          if (activeTab === 'port' || activeTab === 'ambos') {
            basePrice += calculatePortPrice(portData, activeTab, modelList);
          }
          const visibleExtras = extraCharges.filter(extra => !extra.silent);
          visibleExtras.forEach(extra => {
            basePrice += parseFloat(extra.amount) || 0;
          });
          const discount = discountData.enabled ? (basePrice * (discountData.percentage / 100)) : 0;
          const subtotal = basePrice - discount;
          const paypalFee = (subtotal * (paypalData.percentage / 100)) + paypalData.fixed;
          return {
            basePrice,
            discount,
            subtotal,
            paypalFee,
            finalTotal: subtotal + paypalFee,
            extraCharges: visibleExtras
          };
      };

      const generateInvoiceFiles = async () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const invoiceNumber = generateInvoiceNumber();
        const dateLocale = isEnglish ? 'en-US' : 'es';
        const t = (key) => translations[key][isEnglish ? 'en' : 'es'];
        const prices = getTotalPrice();
        const visibles = extraCharges.filter(extra => !extra.silent);

          try {
            // Configuración del canvas
            canvas.width = 800;
            canvas.height = 1200;
            const margin = 50;
            const lineSpacing = 20;
            let y = 160;

            // Fondo blanco base
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dibuja el encabezado
            ctx.fillStyle = '#1e40af';
            ctx.fillRect(0, 0, canvas.width, 160);
            ctx.fillStyle = '#60a5fa';
            ctx.fillRect(0, 140, canvas.width, 20);

            try {
              const img = await loadImage('logo.png');
              // Ajustamos el tamaño del logo
              const logoWidth = 120;
              const logoHeight = 120;
              ctx.drawImage(img, 30, 20, logoWidth, logoHeight);
            } catch (e) {
              console.log('No se pudo cargar el logo');
            }

            // Configuración de texto
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 24px Helvetica';
            ctx.fillText(t('invoiceTitle'), 170, 60);

            ctx.font = '12px Helvetica';
            const dateStr = new Date().toLocaleDateString(dateLocale, { 
              year: 'numeric', 
              month: 'numeric', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
            ctx.fillText(dateStr, 170, 85);

            ctx.font = 'bold 11px Helvetica';
            ctx.fillText(`Factura #${invoiceNumber}`, 170, 105);          // Contenido del PNG
          // Ajustamos el ancho disponible para el contenido
          const availableWidth = canvas.width;

          // Sección Modelo 3D
          if (activeTab === 'modelo' || activeTab === 'ambos') {
            y += 30;
            ctx.fillStyle = '#1e40af';
            ctx.fillRect(0, y - 17, availableWidth, 35);
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 16px Helvetica';
            ctx.fillText(t('modelSection'), 15, y + 5);

            // Detalles del modelo
            modelList.forEach((model, idx) => {
              y += 30;
              ctx.fillStyle = '#FFFFFF';
              ctx.fillRect(0, y, availableWidth, 80);
              
              ctx.fillStyle = '#1e40af';
              ctx.font = 'bold 14px Helvetica';
              ctx.fillText(`• Personaje ${idx + 1}: ${model.name || '(sin nombre)'}`, 15, y + 20);

              ctx.fillStyle = '#4b5563';
              ctx.font = '12px Helvetica';
              if (model.desc) {
                ctx.fillText(model.desc, 25, y + 40);
              }

              ctx.fillText(`- Complejidad: ${model.complexity}/10`, 25, y + 60);
              ctx.fillText(`- Complejidad Textura: ${model.textureComplexity}/5`, 250, y + 60);
              ctx.fillText(`- Tipo: ${getModelTypeTranslation(model.type)}`, 450, y + 60);

              y += 90;
            });

            // Precio estimado modelos
            ctx.fillStyle = '#dcfce7';
            ctx.fillRect(0, y, availableWidth, 35);
            ctx.fillStyle = '#166534';
            ctx.font = 'bold 14px Helvetica';
            
            // Texto a la izquierda
            ctx.fillText('Precio estimado Total Modelos:', 15, y + 22);
            
            // Precio a la derecha
            ctx.textAlign = 'right';
            ctx.fillText(`$${modelList.reduce((sum, model) => sum + calculateModelPrice(model), 0).toFixed(2)} USD`, availableWidth - 15, y + 22);
            ctx.textAlign = 'left';
            y += 40;
          }

          // Sección de precios
          y += 30;
          ctx.fillStyle = '#1f2937';
          ctx.fillRect(0, y, availableWidth, 35);
          ctx.fillStyle = '#FFFFFF';
          ctx.font = 'bold 16px Helvetica';
          ctx.fillText('DESGLOSE DE PRECIOS', 15, y + 22);

          const prices = getTotalPrice();
          y += 35;

          // Precio base
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, y, availableWidth, 30);
          ctx.fillStyle = '#111827';
          ctx.font = '12px Helvetica';
          ctx.fillText('Precio base:', 15, y + 20);
          ctx.textAlign = 'right';
          ctx.fillText(`$${prices.basePrice.toFixed(2)} USD`, availableWidth - 15, y + 20);
          ctx.textAlign = 'left';

          // Extras (solo si hay y son mayores a 0)
          let hasValidExtras = false;
          
          prices.extraCharges.forEach(extra => {
            if (extra.label && extra.amount && parseFloat(extra.amount) > 0) {
              hasValidExtras = true;
              y += 30;
              ctx.fillStyle = '#FFFFFF';
              ctx.fillRect(0, y, availableWidth, 30);
              ctx.fillStyle = '#4b5563';
              ctx.fillText(`+ ${extra.label}:`, 15, y + 20);
              ctx.textAlign = 'right';
              ctx.fillText(`$${parseFloat(extra.amount).toFixed(2)} USD`, availableWidth - 15, y + 20);
              ctx.textAlign = 'left';
            }
          });

          if (!hasValidExtras) {
            y += 30;
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, y, availableWidth, 30);
            ctx.fillStyle = '#808080';
            ctx.font = 'italic 12px Helvetica';
            ctx.textAlign = 'left';
            ctx.fillText(isEnglish ? 'No Extra Details' : 'Sin detalles Extra', 30, y + 20);
          }

          // Descuento
          if (prices.discount > 0) {
            y += 30;
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, y, availableWidth, 30);
            ctx.fillStyle = '#dc2626';
            ctx.fillText(`Descuento (${discountData.percentage}%):`, 15, y + 20);
            ctx.textAlign = 'right';
            ctx.fillText(`-$${prices.discount.toFixed(2)} USD`, availableWidth - 15, y + 20);
            ctx.textAlign = 'left';
          }

          // Línea separadora
          y += 35;
          ctx.strokeStyle = '#0000FF';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(15, y);
          ctx.lineTo(availableWidth - 15, y);
          ctx.stroke();

          // Subtotal
          y += 20;
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, y, availableWidth, 30);
          ctx.fillStyle = '#0000FF';
          ctx.font = 'bold 14px Helvetica';
          ctx.fillText('Subtotal:', 15, y + 20);
          ctx.textAlign = 'right';
          ctx.fillText(`$${prices.subtotal.toFixed(2)} USD`, availableWidth - 15, y + 20);
          ctx.textAlign = 'left';

          // Comisión PayPal
          y += 35;
          ctx.fillStyle = '#fef3c7';
          ctx.fillRect(0, y, availableWidth, 30);
          ctx.fillStyle = '#b45309';
          ctx.font = '12px Helvetica';
          ctx.fillText(`Comisión PayPal (${paypalData.percentage}% + ${paypalData.fixed}):`, 15, y + 20);
          ctx.font = 'bold 12px Helvetica';
          ctx.textAlign = 'right';
          ctx.fillText(`+$${prices.paypalFee.toFixed(2)} USD`, availableWidth - 15, y + 20);
          ctx.textAlign = 'left';

          // Total final
          y += 40;
          ctx.fillStyle = '#1e40af';
          ctx.fillRect(0, y, availableWidth, 50);
          ctx.fillStyle = '#FFFFFF';
          ctx.font = 'bold 20px Helvetica';
          ctx.fillText('TOTAL A PAGAR', 15, y + 30);
          ctx.font = 'bold 24px Helvetica';
          ctx.textAlign = 'right';
          ctx.fillText(`$${prices.finalTotal.toFixed(2)} USD`, availableWidth - 15, y + 30);
          ctx.textAlign = 'left';

          // Pie de página
          ctx.strokeStyle = '#cbd5e1';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(margin, canvas.height - 100);
          ctx.lineTo(canvas.width - 50, canvas.height - 100);
          ctx.stroke();

          ctx.fillStyle = '#6b7280';
          ctx.font = '9px Helvetica';
          ctx.textAlign = 'center';
          ctx.fillText('Esta factura fue generada automáticamente. Para consultas contacte al proveedor.', canvas.width / 2, canvas.height - 85);

          ctx.fillStyle = '#1e40af';
          ctx.font = 'bold 11px Helvetica';
          ctx.fillText('Yoshi Maincra - ' + t('thankYou'), canvas.width / 2, canvas.height - 65);
          ctx.textAlign = 'left';

          // Guardar PNG
          const pngLink = document.createElement('a');
          pngLink.download = `yoshimaincra_commission_${invoiceNumber}.png`;
          pngLink.href = canvas.toDataURL('image/png');
          pngLink.click();

          // Generar PDF
          try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ 
              unit: 'pt', 
              format: 'a4'
            });
            const pdfPageW = doc.internal.pageSize.getWidth();
            const pdfPageH = doc.internal.pageSize.getHeight();
            const pdfMargin = 0;
            const contentWidth = pdfPageW;
            const lineSpacing = 18;
            let cursor = 180; // Ajustamos el cursor para empezar después del encabezado

            // Encabezado azul
            doc.setFillColor(30, 64, 176);
            doc.rect(0, 0, pdfPageW, 160, 'F');
            doc.setFillColor(59, 130, 246);
            doc.rect(0, 140, pdfPageW, 20, 'F');

            // Logo como membrete
            try {
              const img = await loadImage('logo.png');
              const logoWidth = 120;
              const logoHeight = 120;
              doc.addImage(img, 'PNG', 30, 20, logoWidth, logoHeight);
            } catch (e) {
              console.log('No se pudo cargar el logo');
            }

            // Título y fecha
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.setTextColor(255, 255, 255);
            doc.text(t('invoiceTitle'), 170, 60);

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            const dateStr = new Date().toLocaleDateString(dateLocale, { 
              year: 'numeric', 
              month: 'numeric', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
            doc.text(dateStr, 230, 75);

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(`Factura #${invoiceNumber}`, 230, 95);

            // Sección Modelo 3D
            cursor += 50;
            doc.setFillColor(25, 99, 235);
            doc.rect(0, cursor - 17, pdfPageW, 35, 'F');
            doc.setFontSize(16);
            doc.setTextColor(255, 255, 255);
            doc.text(t('modelSection'), 15, cursor + 5);

            // Detalles del modelo
            if (activeTab === 'modelo' || activeTab === 'ambos') {
              cursor += 35;
              doc.setFillColor(255, 255, 255);
              doc.rect(0, cursor, pdfPageW, modelList.length * 108, 'F');
              
              modelList.forEach((model, idx) => {
                cursor += lineSpacing;
                doc.setTextColor(25, 99, 235);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`• Personaje ${idx + 1}: ${model.name || '(sin nombre)'}`, 15, cursor);

                if (model.desc) {
                  cursor += lineSpacing;
                  doc.setTextColor(128, 128, 128);
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'normal');
                  doc.text(model.desc.split('\\n'), 25, cursor);
                }

                cursor += lineSpacing;
                doc.setTextColor(70, 70, 70);
                doc.text([
                  `- Complejidad: ${model.complexity}/10`,
                  `- Complejidad Textura: ${model.textureComplexity}/5`,
                  `- Tipo: ${getModelTypeTranslation(model.type)}`
                ], 25, cursor);
                cursor += lineSpacing * 2;
              });

              // Precio estimado modelos
              doc.setFillColor(220, 252, 231);
              doc.rect(0, cursor, pdfPageW, 35, 'F');
              doc.setTextColor(21, 128, 61);
              doc.setFontSize(14);
              doc.setFont('helvetica', 'bold');
              doc.text(`Precio estimado Total Modelos: `, 15, cursor + 22);
              doc.text(`$${modelList.reduce((sum, model) => sum + calculateModelPrice(model), 0).toFixed(2)} USD`, pdfPageW - 15, cursor + 22, {align: 'right'});
              cursor += 40;
            }

            // Sección Porteo
            if (activeTab === 'port' || activeTab === 'ambos') {
              doc.setFillColor(15, 186, 129);
              doc.rect(pdfMargin, cursor - 17, pdfPageW - 100, 25, 'F');
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(14);
              doc.setFont('helvetica', 'bold');
              doc.text(t('portingSection'), pdfMargin + 10, cursor);

              cursor += 20;
              doc.setFillColor(236, 252, 243);
              doc.rect(pdfMargin, cursor, pdfPageW - 100, 73, 'F');
              doc.setTextColor(21, 128, 61);
              doc.setFontSize(11);
              doc.text([
                `• Juego: ${portData.game.replace('_', ' ').toUpperCase()}`,
                `• Expresiones: ${portData.expressionCount}`,
                portData.expressionNames ? `  Nombres: ${portData.expressionNames}` : '',
                portData.hasPhysics ? '• Con físicas' : '',
                portData.hasAccessories ? `• Con accesorios (Complejidad: ${portData.accessoryComplexity})` : '',
                `Precio estimado: ${calculatePortPrice(portData, activeTab, modelList).toFixed(2)} USD`
              ].filter(Boolean), pdfMargin + 15, cursor + 15);
              cursor += 90;
            }

            // Desglose de precios
            cursor += 20;
            doc.setFillColor(25, 25, 112);
            doc.rect(0, cursor - 17, pdfPageW, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(t('priceBreakdown'), 15, cursor + 5);

            cursor += 35;
            const prices = getTotalPrice();
            
            // Precio base
            doc.setFillColor(255, 255, 255);
            doc.rect(0, cursor, pdfPageW, 30, 'F');
            doc.setTextColor(70, 70, 70);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Precio base:', 15, cursor + 20);
            doc.text(`$${prices.basePrice.toFixed(2)} USD`, pdfPageW - 15, cursor + 20, {align: 'right'});

            // Extras
            cursor += 5;
            let hasValidExtras = false;
            
            prices.extraCharges.forEach(extra => {
              if (extra.label && extra.amount && parseFloat(extra.amount) > 0) {
                hasValidExtras = true;
                doc.setFillColor(255, 255, 255);
                doc.rect(0, cursor, pdfPageW, 30, 'F');
                doc.setTextColor(70, 70, 70);
                doc.setFont('helvetica', 'normal');
                doc.text(`+ ${extra.label}:`, 15, cursor + 20);
                doc.text(`$${parseFloat(extra.amount).toFixed(2)} USD`, pdfPageW - 15, cursor + 20, {align: 'right'});
                cursor += 30;
              }
            });

            if (!hasValidExtras) {
              doc.setFillColor(255, 255, 255);
              doc.rect(0, cursor, pdfPageW, 30, 'F');
              doc.setTextColor(128, 128, 128);
              doc.setFont('helvetica', 'italic');
              doc.text(isEnglish ? 'No Extra Details' : 'Sin detalles Extra', 30, cursor + 20);
              cursor += 30;
            }

            // Descuento
            if (prices.discount > 0) {
              doc.setFillColor(255, 255, 255);
              doc.rect(0, cursor, pdfPageW, 30, 'F');
              doc.setTextColor(255, 0, 0);
              doc.setFont('helvetica', 'normal');
              doc.text(`${t('discountPercent')} (${discountData.percentage}%):`, 15, cursor + 20);
              doc.text(`-$${prices.discount.toFixed(2)} USD`, pdfPageW - 15, cursor + 20, {align: 'right'});
              cursor += 35;
            }

            // Línea separadora antes del subtotal
            cursor += 10;
            // Dibujamos un rectángulo fino de extremo a extremo
            doc.setFillColor(0, 0, 255);
            doc.rect(0, cursor, pdfPageW, 2, 'F');
            cursor += 15;

            // Subtotal
            doc.setFillColor(255, 255, 255);
            doc.rect(0, cursor, pdfPageW, 30, 'F');
            doc.setTextColor(0, 0, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Subtotal:', 15, cursor + 20);
            doc.text(`$${prices.subtotal.toFixed(2)} USD`, pdfPageW - 15, cursor + 20, {align: 'right'});

            // Comisión PayPal
            cursor += 35;
            doc.setFillColor(255, 243, 199);
            doc.rect(0, cursor, pdfPageW, 30, 'F');
            doc.setTextColor(180, 83, 9);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Comisión PayPal (${paypalData.percentage}% + ${paypalData.fixed}):`, 15, cursor + 20);
            doc.setFont('helvetica', 'bold');
            doc.text(`+$${prices.paypalFee.toFixed(2)} USD`, pdfPageW - 15, cursor + 20, {align: 'right'});

            // Total final
            cursor += 40;
            doc.setFillColor(25, 99, 235);
            doc.rect(0, cursor, pdfPageW, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('TOTAL A PAGAR', 15, cursor + 30);
            doc.text(`$${prices.finalTotal.toFixed(2)} USD`, pdfPageW - 15, cursor + 30, {align: 'right'});

            // Línea separadora y pie de página
            doc.setDrawColor(203, 213, 225);
            doc.setLineWidth(1);
            doc.line(pdfMargin, pdfPageH - 100, pdfPageW - 50, pdfPageH - 100);

            doc.setTextColor(107, 114, 128);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Esta factura fue generada automáticamente. Para consultas contacte al proveedor.', pdfPageW / 2, pdfPageH - 85, { align: 'center' });

            doc.setTextColor(30, 64, 175);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('Yoshi Maincra - ' + t('thankYou'), pdfPageW / 2, pdfPageH - 65, { align: 'center' });

            doc.save(`yoshimaincra_commission_${invoiceNumber}.pdf`);
          } catch (e) {
            console.error('Error generando PDF:', e);
          }
        } catch (e) {
          console.error('Error generando documentos:', e);
        }
      };

      // Renderizado del componente
      return (
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-2xl shadow-sm p-6 mb-6">
            <div className="flex items-center gap-3 mb-4">
              <Calculator />
              <h1 className="text-2xl font-bold text-gray-900">Calculadora de Comisiones 3D</h1>
            </div>
            <div className="flex gap-2 items-center">
              {[
                {id:'modelo', label:'Solo Modelo', icon:Package},
                {id:'port', label:'Solo Porteo', icon:Settings},
                {id:'ambos', label:'Modelo + Porteo', icon:DollarSign}
              ].map(tab => (
                <button 
                  key={tab.id} 
                  onClick={() => setActiveTab(tab.id)} 
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${
                    (activeTab === tab.id) ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  <tab.icon />{tab.label}
                </button>
              ))}
              <button
                className="ml-2 p-1 rounded hover:bg-red-100 border border-red-200"
                title="Limpiar todo"
                onClick={() => {
                  if(window.confirm('¿Seguro que quieres limpiar todos los datos?')){
                    localStorage.clear();
                    window.location.reload();
                  }
                }}
              >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-5 h-5 text-red-600">
                  <path fillRule="evenodd" d="M7.5 3.5A1.5 1.5 0 0 1 9 2h2a1.5 1.5 0 0 1 1.5 1.5V4H16a1 1 0 1 1 0 2h-1v10.5A2.5 2.5 0 0 1 12.5 19h-5A2.5 2.5 0 0 1 5 16.5V6H4a1 1 0 1 1 0-2h3.5v-.5ZM7 6v10.5c0 .276.224.5.5.5h5a.5.5 0 0 0 .5-.5V6H7Z" clipRule="evenodd"/>
                </svg>
              </button>
            </div>
          </div>

          <div className="grid lg:grid-cols-2 gap-6">
            <div className="space-y-6">
              {(activeTab === 'modelo' || activeTab === 'ambos') && modelList && modelList.length > 0 && (
                <div className="bg-white rounded-2xl shadow-sm p-6">
                  <h2 className="text-xl font-semibold text-gray-900 mb-4">Configuración de Personajes</h2>
                  <div className="space-y-4">
                    {modelList.map((model, idx) => (
                      <div key={idx} className="border rounded-lg p-4 mb-2 bg-gray-50">
                        <div className="flex items-center justify-between mb-2">
                          <span className="font-semibold text-blue-700">Personaje {idx + 1}</span>
                          {modelList.length > 1 && (
                            <button 
                              type="button" 
                              className="text-red-500 text-xs" 
                              onClick={() => setModelList(modelList.filter((_, i) => i !== idx))}
                            >
                              Eliminar
                            </button>
                          )}
                        </div>
                        <input 
                          type="text" 
                          placeholder="Nombre del personaje" 
                          className="w-full mb-2 px-2 py-1 border rounded" 
                          value={model.name} 
                          onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, name: e.target.value} : m))} 
                        />
                        <textarea
                          placeholder="Descripción de la comisión"
                          className="w-full mb-2 px-2 py-1 border rounded resize-none"
                          value={model.desc}
                          onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, desc: e.target.value} : m))}
                          rows={1}
                          onInput={e => {
                            e.target.style.height = 'auto';
                            e.target.style.height = (e.target.scrollHeight) + 'px';
                          }}
                        />
                        <div className="mb-2">
                          <label className="block text-xs font-medium text-gray-700 mb-1">Complejidad (1-10)</label>
                          <input 
                            type="range" 
                            min="1" 
                            max="10" 
                            value={model.complexity} 
                            onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, complexity: parseInt(e.target.value)} : m))} 
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" 
                          />
                          <div className="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Simple</span>
                            <span className="font-medium">{model.complexity}</span>
                            <span>Complejo</span>
                          </div>
                        </div>
                        <div className="mb-2">
                          <label className="block text-xs font-medium text-gray-700 mb-1">Complejidad de Texturizado (0-5)</label>
                          <input 
                            type="range" 
                            min="0" 
                            max="5" 
                            value={model.textureComplexity} 
                            onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, textureComplexity: parseInt(e.target.value)} : m))} 
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" 
                          />
                          <div className="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Ninguno</span>
                            <span className="font-medium">{model.textureComplexity}</span>
                            <span>Alto</span>
                          </div>
                        </div>
                        <div className="mb-2">
                          <label className="block text-xs font-medium text-gray-700 mb-1">Tipo de modelo</label>
                          <select 
                            className="w-full px-2 py-1 border rounded" 
                            value={model.type} 
                            onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, type: e.target.value} : m))}
                          >
                            <option value="total">Hecho total de 0</option>
                            <option value="edit">Model Edit</option>
                            <option value="partial">Parcial</option>
                            <option value="accessories">Solo accesorios parciales</option>
                          </select>
                        </div>
                        <div className="space-y-2 mt-2">
                          <div className="space-y-2">
                            <div className="flex items-center">
                              <input 
                                type="checkbox" 
                                id={`hasExpressions-${idx}`}
                                checked={model.hasExpressions} 
                                onChange={(e) => setModelList(modelList.map((m, i) => i === idx ? {...m, hasExpressions: e.target.checked} : m))} 
                                className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" 
                              />
                              <label htmlFor={`hasExpressions-${idx}`} className="ml-2 text-sm font-medium text-gray-700">
                                Incluir expresiones faciales
                              </label>
                            </div>
                            {model.hasExpressions && (
                              <div className="ml-6 space-y-2">
                                <label className="block text-xs font-medium text-gray-700 mb-1">
                                  Número de expresiones
                                </label>
                                <input
                                  type="number"
                                  min="1"
                                  max="20"
                                  value={model.expressionCount || 1}
                                  onChange={(e) => setModelList(modelList.map((m, i) => 
                                    i === idx ? {...m, expressionCount: Math.max(1, Math.min(20, parseInt(e.target.value) || 1))} : m
                                  ))}
                                  className="w-20 px-2 py-1 border rounded"
                                />
                                <label className="block text-xs font-medium text-gray-700 mb-1 mt-2">
                                  Nombres de expresiones (separadas por comas)
                                </label>
                                <textarea
                                  value={model.expressionNames || ''}
                                  onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, expressionNames: e.target.value} : m))}
                                  placeholder="feliz, triste, enojado..."
                                  className="w-full px-2 py-1 border rounded resize-none"
                                  rows={1}
                                  style={{minHeight:'40px',paddingBottom:'12px',marginBottom:'8px',overflow:'hidden'}}
                                  onInput={e => {
                                    e.target.style.height = 'auto';
                                    e.target.style.height = (e.target.scrollHeight + 16) + 'px';
                                  }}
                                />
                              </div>
                            )}
                          </div>
                          <div className="flex items-center">
                            <input 
                              type="checkbox" 
                              id={`hasPhysics-${idx}`}
                              checked={model.hasPhysics} 
                              onChange={(e) => setModelList(modelList.map((m, i) => i === idx ? {...m, hasPhysics: e.target.checked} : m))} 
                              className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" 
                            />
                            <label htmlFor={`hasPhysics-${idx}`} className="ml-2 text-sm font-medium text-gray-700">
                              Incluir físicas
                            </label>
                          </div>
                          {model.hasPhysics && (
                            <div className="ml-6 space-y-2 mt-2">
                              <label className="block text-xs font-medium text-gray-700 mb-1">Opciones de físicas:</label>
                              <div className="flex flex-wrap gap-4">
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={model.physicsBust || false} onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, physicsBust: e.target.checked} : m))} />
                                  Busto
                                </label>
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={model.physicsHair || false} onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, physicsHair: e.target.checked} : m))} />
                                  Pelo
                                </label>
                                {model.physicsHair && (
                                  <div className="flex items-center gap-2">
                                    <span className="text-xs">Complejidad pelo</span>
                                    <input type="range" min="1" max="5" value={model.physicsHairComplexity || 1} onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, physicsHairComplexity: parseInt(e.target.value)} : m))} />
                                    <span className="text-xs font-bold">{model.physicsHairComplexity || 1}</span>
                                  </div>
                                )}
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={model.physicsEar || false} onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, physicsEar: e.target.checked} : m))} />
                                  Orejas
                                </label>
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={model.physicsTail || false} onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, physicsTail: e.target.checked} : m))} />
                                  Cola
                                </label>
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={model.physicsOther || false} onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, physicsOther: e.target.checked} : m))} />
                                  Otro
                                </label>
                                {model.physicsOther && (
                                  <div className="flex flex-col gap-1 ml-6">
                                    <input type="text" placeholder="¿Qué es?" value={model.physicsOtherDesc || ''} onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, physicsOtherDesc: e.target.value} : m))} className="px-2 py-1 border rounded mb-1" />
                                    <input type="number" step="0.01" min="0" placeholder="Precio USD" value={model.physicsOtherPrice || ''} onChange={e => setModelList(modelList.map((m, i) => i === idx ? {...m, physicsOtherPrice: e.target.value} : m))} className="px-2 py-1 border rounded" />
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                          <div className="flex items-center">
                            <input 
                              type="checkbox" 
                              id={`hasAccessories-${idx}`}
                              checked={model.hasAccessories} 
                              onChange={(e) => setModelList(modelList.map((m, i) => i === idx ? {...m, hasAccessories: e.target.checked} : m))} 
                              className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" 
                            />
                            <label htmlFor={`hasAccessories-${idx}`} className="ml-2 text-sm font-medium text-gray-700">
                              Accesorios y ropa adicionales
                            </label>
                          </div>
                        </div>
                      </div>
                    ))}
                    <button 
                      type="button" 
                      className="mt-2 px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm" 
                      onClick={() => setModelList([...modelList, { 
                        name: '', 
                        desc: '', 
                        complexity: 5, 
                        type: 'total', 
                        textureComplexity: 0, 
                        hasExpressions: false, 
                        hasPhysics: false, 
                        hasAccessories: false,
                        expressionCount: 1
                      }])}
                    >
                      Añadir personaje
                    </button>
                  </div>
                </div>
              )}
              
              {(activeTab === 'port' || activeTab === 'ambos') && (
                <div className="bg-white rounded-2xl shadow-sm p-6">
                  <h2 className="text-xl font-semibold text-gray-900 mb-4">Configuración del Porteo</h2>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Juego</label>
                      <select 
                        value={portData.game} 
                        onChange={(e) => setPortData(prev => ({...prev, game: e.target.value}))} 
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        <option value="gta_sa">GTA San Andreas</option>
                        <option value="gta_vc">GTA Vice City</option>
                        <option value="gta_v">GTA V</option>
                        <option value="garrys_mod">Garry's Mod</option>
                        <option value="left4dead2">Left 4 Dead 2</option>
                        <option value="vrm">VRM</option>
                      </select>
                    </div>
                    <div className="flex items-center">
                      <input 
                        type="checkbox" 
                        id="hasExpressions" 
                        checked={portData.hasExpressions} 
                        onChange={(e) => setPortData(prev => ({...prev, hasExpressions: e.target.checked}))} 
                        className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" 
                      />
                      <label htmlFor="hasExpressions" className="ml-2 text-sm font-medium text-gray-700">
                        Incluir expresiones faciales
                      </label>
                    </div>
                    {portData.hasExpressions && (
                      <>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">Cantidad de expresiones</label>
                          <input 
                            type="number" 
                            min="1" 
                            value={portData.expressionCount} 
                            onChange={(e) => setPortData(prev => ({...prev, expressionCount: parseInt(e.target.value) || 0}))} 
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Nombres de expresiones (separadas por comas, opcional)
                          </label>
                          <textarea 
                            value={portData.expressionNames} 
                            onChange={(e) => setPortData(prev => ({...prev, expressionNames: e.target.value}))} 
                            placeholder="feliz, triste, enojado..." 
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                            rows="2" 
                          />
                        </div>
                      </>
                    )}
                    {(portData.game === 'garrys_mod' || portData.game === 'vrm') && (
                      <>
                        <div className="flex items-center">
                          <input 
                            type="checkbox" 
                            id="hasPhysics" 
                            checked={portData.hasPhysics} 
                            onChange={(e) => setPortData(prev => ({...prev, hasPhysics: e.target.checked}))} 
                            className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" 
                          />
                          <label htmlFor="hasPhysics" className="ml-2 text-sm font-medium text-gray-700">
                            Incluir físicas
                          </label>
                        </div>
                        {portData.game === 'garrys_mod' && (
                          <>
                            <div className="flex items-center">
                              <input 
                                type="checkbox" 
                                id="hasAccessories" 
                                checked={portData.hasAccessories} 
                                onChange={(e) => setPortData(prev => ({...prev, hasAccessories: e.target.checked}))} 
                                className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" 
                              />
                              <label htmlFor="hasAccessories" className="ml-2 text-sm font-medium text-gray-700">
                                Accesorios y ropa adicionales
                              </label>
                            </div>
                            {portData.hasAccessories && (
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                  Complejidad de accesorios (1-5)
                                </label>
                                <input 
                                  type="range" 
                                  min="1" 
                                  max="5" 
                                  value={portData.accessoryComplexity} 
                                  onChange={(e) => setPortData(prev => ({...prev, accessoryComplexity: parseInt(e.target.value)}))} 
                                  className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider" 
                                />
                                <div className="flex justify-between text-xs text-gray-500 mt-1">
                                  <span>Simple</span>
                                  <span className="font-medium">{portData.accessoryComplexity}</span>
                                  <span>Complejo</span>
                                </div>
                              </div>
                            )}
                            <div className="ml-6 space-y-2 mt-2">
                              <label className="block text-xs font-medium text-gray-700 mb-1">Opciones de físicas:</label>
                              <div className="flex flex-wrap gap-4">
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={portData.physicsBust || false} onChange={e => setPortData(prev => ({...prev, physicsBust: e.target.checked}))} />
                                  Busto
                                </label>
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={portData.physicsHair || false} onChange={e => setPortData(prev => ({...prev, physicsHair: e.target.checked}))} />
                                  Pelo
                                </label>
                                {portData.physicsHair && (
                                  <div className="flex items-center gap-2">
                                    <span className="text-xs">Complejidad pelo</span>
                                    <input type="range" min="1" max="5" value={portData.physicsHairComplexity || 1} onChange={e => setPortData(prev => ({...prev, physicsHairComplexity: parseInt(e.target.value)}))} />
                                    <span className="text-xs font-bold">{portData.physicsHairComplexity || 1}</span>
                                  </div>
                                )}
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={portData.physicsTail || false} onChange={e => setPortData(prev => ({...prev, physicsTail: e.target.checked}))} />
                                  Cola
                                </label>
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={portData.physicsEar || false} onChange={e => setPortData(prev => ({...prev, physicsEar: e.target.checked}))} />
                                  Oreja
                                </label>
                                <label className="flex items-center gap-1">
                                  <input type="checkbox" checked={portData.physicsOther || false} onChange={e => setPortData(prev => ({...prev, physicsOther: e.target.checked}))} />
                                  Otro
                                </label>
                                {portData.physicsOther && (
                                  <div className="flex flex-col gap-1 ml-6">
                                    <input type="text" placeholder="¿Qué es?" value={portData.physicsOtherDesc || ''} onChange={e => setPortData(prev => ({...prev, physicsOtherDesc: e.target.value}))} className="px-2 py-1 border rounded mb-1" />
                                    <input type="number" step="0.01" min="0" placeholder="Precio USD" value={portData.physicsOtherPrice || ''} onChange={e => setPortData(prev => ({...prev, physicsOtherPrice: e.target.value}))} className="px-2 py-1 border rounded" />
                                  </div>
                                )}
                              </div>
                            </div>
                          </>
                        )}
                      </>
                    )}
                  </div>
                </div>
              )}
              
              <div className="bg-white rounded-2xl shadow-sm p-6">
                <h2 className="text-xl font-semibold text-gray-900 mb-4">Comisión/IVA PayPal</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Porcentaje de comisión PayPal (%)
                    </label>
                    <input 
                      type="number" 
                      min="0" 
                      step="0.01" 
                      value={paypalData.percentage} 
                      onChange={e => setPaypalData(prev => ({...prev, percentage: parseFloat(e.target.value) || 0}))} 
                      className="w-full p-3 border border-gray-300 rounded-lg" 
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Tarifa fija PayPal (USD)</label>
                    <input 
                      type="number" 
                      min="0" 
                      step="0.01" 
                      value={paypalData.fixed} 
                      onChange={e => setPaypalData(prev => ({...prev, fixed: parseFloat(e.target.value) || 0}))} 
                      className="w-full p-3 border border-gray-300 rounded-lg" 
                    />
                  </div>
                  <div className="text-xs text-gray-500">
                    Puedes ajustar el porcentaje y tarifa fija según el país o el IVA de PayPal.
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow-sm p-6">
                <h2 className="text-xl font-semibold text-gray-900 mb-4">Cobros Extra</h2>
                <div className="space-y-3">
                  {extraCharges.map((extra, idx) => (
                    <div key={idx} className="flex flex-col md:flex-row md:items-center gap-2 border-b pb-2">
                      <input 
                        type="text" 
                        placeholder="Concepto" 
                        value={extra.label} 
                        onChange={e => setExtraCharges(extraCharges.map((c, i) => i === idx ? { ...c, label: e.target.value } : c))} 
                        className="flex-1 p-2 border rounded" 
                      />
                      <input 
                        type="number" 
                        step="0.01" 
                        placeholder="Monto" 
                        value={extra.amount} 
                        onChange={e => setExtraCharges(extraCharges.map((c, i) => i === idx ? { ...c, amount: e.target.value } : c))} 
                        className="w-28 p-2 border rounded" 
                      />
                      <label className="flex items-center gap-1 text-xs">
                        <input 
                          type="checkbox" 
                          checked={extra.silent} 
                          onChange={e => setExtraCharges(extraCharges.map((c, i) => i === idx ? { ...c, silent: e.target.checked } : c))} 
                        />
                        Cobro silencioso
                      </label>
                      <button 
                        type="button" 
                        title="Eliminar" 
                        className="ml-2 p-1 rounded hover:bg-red-50 text-red-600 flex items-center justify-center" 
                        style={{height:'32px',width:'32px',minWidth:'32px'}} 
                        onClick={() => setExtraCharges(extraCharges.filter((_, i) => i !== idx))}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  ))}
                  <button 
                    type="button" 
                    className="mt-2 px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm" 
                    onClick={() => setExtraCharges([...extraCharges, { label: '', amount: '', silent: false }])}
                  >
                    Añadir cobro extra
                  </button>
                </div>
              </div>
              
              <div className="bg-white rounded-2xl shadow-sm p-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-semibold text-gray-900">Descuento</h2>
                  <div className="flex items-center">
                    <input 
                      type="checkbox" 
                      id="discountEnabled" 
                      checked={discountData.enabled} 
                      onChange={(e) => setDiscountData(prev => ({...prev, enabled: e.target.checked}))} 
                      className="w-4 h-4 text-blue-600 bg-gray-100 border border-gray-300 rounded" 
                    />
                    <label htmlFor="discountEnabled" className="ml-2 text-sm font-medium text-gray-700">
                      Aplicar descuento
                    </label>
                  </div>
                </div>
                {discountData.enabled && (
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Porcentaje de descuento (%)
                      </label>
                      <input 
                        type="number" 
                        min="0" 
                        max="100" 
                        value={discountData.percentage} 
                        onChange={(e) => setDiscountData(prev => ({...prev, percentage: parseFloat(e.target.value) || 0}))} 
                        className="w-full p-3 border border-gray-300 rounded-lg" 
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Motivo del descuento</label>
                      <input 
                        type="text" 
                        value={discountData.reason} 
                        onChange={(e) => setDiscountData(prev => ({...prev, reason: e.target.value}))} 
                        placeholder="Cliente frecuente, promoción..." 
                        className="w-full p-3 border border-gray-300 rounded-lg" 
                      />
                    </div>
                  </div>
                )}
              </div>
            </div>

            <div className="space-y-6">
              <div className="bg-white rounded-2xl shadow-sm p-6">
                <h2 className="text-xl font-semibold text-gray-900 mb-4">Resumen de Precios</h2>
                <div className="space-y-4">
                  <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span className="font-medium text-gray-700">Precio base:</span>
                    <span className="font-semibold text-lg">${getTotalPrice().basePrice.toFixed(2)} USD</span>
                  </div>
                  
                  {getTotalPrice().extraCharges.map((extra, idx) => (
                    <div key={idx} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                      <span className="font-medium text-gray-700">{extra.label || 'Extra'}:</span>
                      <span className="font-semibold text-lg">+${parseFloat(extra.amount || 0).toFixed(2)} USD</span>
                    </div>
                  ))}
                  
                  {getTotalPrice().discount > 0 && (
                    <div className="p-3 bg-red-50 rounded-lg">
                      <div className="flex justify-between items-center">
                        <span className="font-medium text-red-700">Descuento ({discountData.percentage}%):</span>
                        <span className="font-semibold text-lg text-red-600">-${getTotalPrice().discount.toFixed(2)} USD</span>
                      </div>
                      {discountData.reason && (
                        <div className="mt-1 text-sm text-red-600">Motivo: {discountData.reason}</div>
                      )}
                    </div>
                  )}
                  
                  <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span className="font-medium text-gray-700">Subtotal:</span>
                    <span className="font-semibold text-lg">${getTotalPrice().subtotal.toFixed(2)} USD</span>
                  </div>
                  
                  <div className="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                    <span className="font-medium text-yellow-700">Comisión PayPal:</span>
                    <span className="font-semibold text-lg text-yellow-600">${getTotalPrice().paypalFee.toFixed(2)} USD</span>
                  </div>
                  
                  <div className="border-t pt-4">
                    <div className="flex justify-between items-center p-4 bg-blue-600 text-white rounded-lg">
                      <span className="font-bold text-lg">Total a pagar:</span>
                      <span className="font-bold text-2xl">${getTotalPrice().finalTotal.toFixed(2)} USD</span>
                    </div>
                  </div>
                </div>
                
                <div className="flex items-center justify-center mt-6 mb-2">
                  <input 
                    type="checkbox" 
                    id="langToggle" 
                    checked={isEnglish} 
                    onChange={(e) => setIsEnglish(e.target.checked)} 
                    className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" 
                  />
                  <label htmlFor="langToggle" className="ml-2 text-sm font-medium text-gray-700">
                    Generar en Inglés / Generate in English
                  </label>
                </div>
                
                <button 
                  onClick={generateInvoiceFiles} 
                  className="w-full flex items-center justify-center gap-2 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium"
                >
                  <Download />
                  Generar Factura (PNG + PDF)
                </button>
              </div>

              <div className="bg-white rounded-2xl shadow-sm p-6">
                <h2 className="text-xl font-semibold text-gray-900 mb-4">Detalles del Servicio</h2>
                <div className="space-y-3 text-sm text-gray-600">
                  {(activeTab === 'modelo' || activeTab === 'ambos') && (
                    <div className="p-3 bg-blue-50 rounded-lg">
                      <h3 className="font-medium text-blue-900 mb-2">Modelo 3D:</h3>
                      {modelList.map((model, idx) => (
                        <div key={idx} className="mb-2">
                          <p>• Personaje {idx + 1}: {model.name || '(sin nombre)'}</p>
                          {model.desc && <p className="ml-4">- {model.desc}</p>}
                          <p className="ml-4">- Complejidad: {model.complexity}/10</p>
                          <p className="ml-4">- Textura: {model.textureComplexity}/5</p>
                          <p className="ml-4">- Tipo: {model.type.charAt(0).toUpperCase() + model.type.slice(1)}</p>
                        </div>
                      ))}
                      <p>• Precio estimado: ${modelList.reduce((sum, model) => sum + calculateModelPrice(model), 0).toFixed(2)} USD</p>
                    </div>
                  )}
                  
                  {(activeTab === 'port' || activeTab === 'ambos') && (
                    <div className="p-3 bg-green-50 rounded-lg">
                      <h3 className="font-medium text-green-900 mb-2">Porteo:</h3>
                      <p>• Juego: {portData.game.replace('_', ' ').toUpperCase()}</p>
                      {portData.hasExpressions && (
                        <>
                          <p>• Expresiones: {portData.expressionCount}</p>
                          {portData.expressionNames && (
                            <p>• Nombres: {portData.expressionNames}</p>
                          )}
                        </>
                      )}
                      {portData.hasPhysics && <p>• Con físicas</p>}
                      {portData.hasAccessories && <p>• Con accesorios (Complejidad: {portData.accessoryComplexity})</p>}
                      <p>• Precio estimado: ${calculatePortPrice(portData, activeTab, modelList).toFixed(2)} USD</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
          
          <canvas ref={canvasRef} style={{ display: 'none' }} width="800" height="1200" />
        </div>
      );
    }

    // Renderizar la aplicación
    root.render(<CommissionCalculator />);
  </script>
</body>
</html>
